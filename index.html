<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
<script src='//libtl.com/sdk.js' data-zone='9771272' data-sdk='show_9771272'></script>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root {
    --tg-theme-bg-color: #121212;
    --tg-theme-text-color: #e0e0e0;
    --tg-theme-button-color: #007bff;
    --tg-theme-button-text-color: #ffffff;
    --tg-theme-hint-color: #8a8a8a;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --secondary-bg-color: #1e1e1e;
    --border-color: #333333;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 20px 15px 90px 15px;
    background-color: var(--tg-theme-bg-color);
    color: var(--tg-theme-text-color);
    display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 100vh;
    box-sizing: border-box;
  }
  .container { width: 100%; max-width: 500px; }
  .view { display: none; width: 100%; animation: fadeIn .3s ease-in-out; }
  #home-view { display: block; }
  @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
  .header { margin-bottom: 25px; }
  .header h1 { font-size: 32px; font-weight: 700; margin-bottom: 5px; color: #fff; }
  .header p { color: var(--tg-theme-hint-color); font-size: 16px; }

  .card { background: var(--secondary-bg-color); padding: 25px; border-radius: 16px; margin-bottom: 25px;
    box-shadow: 0 8px 16px rgba(0,0,0,.2); border: 1px solid var(--border-color); }
  .card h2 { margin: 0 0 12px 0; font-size: 16px; color: var(--tg-theme-hint-color); font-weight: 500; text-transform: uppercase; letter-spacing: .5px; }

  .balance-amount { font-size: 42px; font-weight: 700; color: #fff; margin-bottom: 10px; }
  .ad-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
  .ad-info-item h3 { font-size: 20px; font-weight: 600; margin: 0 0 5px 0; color: #fff; }
  .ad-info-item p { font-size: 14px; color: var(--tg-theme-hint-color); margin: 0; }

  .ad-buttons { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
  .btn { width: 100%; padding: 16px; font-size: 18px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer;
    transition: transform .2s, background-color .2s, box-shadow .2s;
    background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
    color: var(--tg-theme-button-text-color);
    box-shadow: 0 4px 10px rgba(0,123,255,.2);
  }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,123,255,.3); }
  .btn:active { transform: scale(.98); }
  .btn:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; transform: none; }
  #mainWithdrawBtn { background: linear-gradient(145deg, var(--success-color), #1e7e34); box-shadow: 0 4px 10px rgba(40,167,69,.2); }
  #mainWithdrawBtn:disabled { background: #555; box-shadow: none; }

  .status-message {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 480px;
    padding: 12px 15px; border-radius: 10px; font-weight: 500; display: none; z-index: 1000; box-sizing: border-box;
  }
  .success { display: block; background-color: rgba(40, 167, 69, .25); border-left: 5px solid var(--success-color); color: var(--success-color); }
  .error { display: block; background-color: rgba(220, 53, 69, .25); border-left: 5px solid var(--danger-color); color: var(--danger-color); }
  .info { display: block; background-color: rgba(0, 123, 255, .25); border-left: 5px solid var(--tg-theme-button-color); color: #008cff; }

  .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--secondary-bg-color); display: flex;
    justify-content: space-around; padding: 10px 0; box-shadow: 0 -4px 12px rgba(0,0,0,.3); border-top: 1px solid var(--border-color); z-index: 999;}
  .nav-btn { background: none; border: none; color: var(--tg-theme-hint-color); display: flex; flex-direction: column; align-items: center;
    font-size: 12px; font-weight: 500; cursor: pointer; padding: 5px 15px; border-radius: 12px; transition: color .2s, background-color .2s; }
  .nav-btn.active { color: var(--tg-theme-button-color); }
  .nav-btn .icon { width: 28px; height: 28px; margin-bottom: 4px; }

  .input-group { margin-bottom: 20px; text-align: left; }
  .input-group label { display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color); font-size: 14px; font-weight: 500; }
  .input-group input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);
    background-color: #333; color: var(--tg-theme-text-color); font-size: 16px; box-sizing: border-box; }
  .input-group input:focus { outline: none; border-color: var(--tg-theme-button-color); box-shadow: 0 0 0 3px rgba(0,123,255,.2); }

  #referralLink { background-color: #111; padding: 15px; border-radius: 10px; word-wrap: break-word; border: 1px dashed var(--tg-theme-hint-color);
    margin-top: 15px; cursor: pointer; color: #e0e0e0; transition: background-color .2s; text-align: left; }
  #referralLink:hover { background-color: #2a2a2a; }

  .admin-panel { display: none; margin-top: 30px; padding: 15px; border: 1px solid var(--warning-color);
    border-radius: 10px; background-color: rgba(255, 193, 7, .1); }
  .admin-panel h3 { color: var(--warning-color); margin-top: 0; }
</style>
</head>
<body>
    <script src='//libtl.com/sdk.js' data-zone='9771272' data-sdk='show_9771272'></script>
<div class="container">
  <div id="home-view" class="view">
    <div class="header"><h1>Earning Technology</h1><p>Watch Ads and Earn USDT</p></div>
    <div class="card">
      <h2>Current Balance</h2>
      <div class="balance-amount" id="balanceDisplay">USDT 0.00</div>
      <div class="ad-info-grid">
        <div class="ad-info-item"><h3 id="adCountDisplay">0</h3><p>Total Ads Watched</p></div>
        <div class="ad-info-item"><h3 id="dailyAdCountDisplay">0 / 10</h3><p>Today's Ads</p></div>
      </div>
    </div>
    <div class="ad-buttons"><button class="btn" id="rewardedBtn">Watch Ad (+0.01 USDT)</button></div>
    <button class="btn" id="mainWithdrawBtn" disabled>Reach 1.00 USDT to Withdraw</button>
  </div>

  <div id="withdraw-view" class="view">
    <div class="header"><h1>Withdraw</h1><p>Request your earnings</p></div>
    <div class="card">
      <h2>Your Balance</h2>
      <div class="balance-amount" id="withdrawBalanceDisplay">USDT 0.00</div>
      <p style="color: var(--tg-theme-hint-color); margin-top: 15px;">Minimum withdrawal is 1.00 USDT.</p>
    </div>
    <div class="card">
      <h2>Payment Details</h2>
      <div class="input-group">
        <label for="paymentAddress">Your USDT Wallet Address (TRC20)</label>
        <input type="text" id="paymentAddress" placeholder="e.g., T... (TRC20 Address)">
      </div>
      <button class="btn" id="finalWithdrawBtn" disabled>Withdraw</button>
    </div>
  </div>

  <div id="referral-view" class="view">
    <div class="header"><h1>Referrals</h1><p>Invite friends and earn more!</p></div>
    <div class="card">
      <h2>Your Referral Stats</h2>
      <div class="ad-info-grid">
        <div class="ad-info-item"><h3 id="referralCountDisplay">0</h3><p>Total Referrals</p></div>
        <div class="ad-info-item"><h3 id="referralBonusDisplay">USDT 0.00</h3><p>Referral Earnings</p></div>
      </div>
    </div>
    <div class="card">
      <h2>Your Referral Link</h2>
      <p>Share this link with your friends. You get 0.5 USDT for each verified friend who joins!</p>
      <p id="referralLink" title="Click to copy"></p>
      <p style="font-size:12px; color:var(--tg-theme-hint-color); margin-top:15px;">Referral rewards are handled on the server.</p>
    </div>
  </div>

  <div class="status-message" id="statusMessage"></div>
  <div class="admin-panel" id="adminPanel"><h3>ðŸ‘‘ Admin Panel</h3><p id="userInfo"></p></div>
</div>

<footer class="footer-nav">
  <button class="nav-btn active" id="navHome">
    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>
    <span>Home</span>
  </button>
  <button class="nav-btn" id="navWithdraw">
    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/></svg></span>
    <span>Withdraw</span>
  </button>
  <button class="nav-btn" id="navRefer">
    <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span>
    <span>Referrals</span>
  </button>
</footer>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();

  // --- DOM
  const balanceDisplay = document.getElementById('balanceDisplay');
  const adCountDisplay = document.getElementById('adCountDisplay');
  const dailyAdCountDisplay = document.getElementById('dailyAdCountDisplay');
  const rewardedBtn = document.getElementById('rewardedBtn');
  const mainWithdrawBtn = document.getElementById('mainWithdrawBtn');
  const statusMessage = document.getElementById('statusMessage');
  const withdrawBalanceDisplay = document.getElementById('withdrawBalanceDisplay');
  const paymentAddressInput = document.getElementById('paymentAddress');
  const finalWithdrawBtn = document.getElementById('finalWithdrawBtn');
  const referralLinkDisplay = document.getElementById('referralLink');
  const referralCountDisplay = document.getElementById('referralCountDisplay');
  const referralBonusDisplay = document.getElementById('referralBonusDisplay');
  const adminPanel = document.getElementById('adminPanel');
  const userInfoDisplay = document.getElementById('userInfo');

  let CONFIG = {
    dailyAdLimit: 1000,
    adRewardCents: 1,
    referralBonusCents: 50,
    withdrawThresholdCents: 1000,
    botUsername: 'YourBotUsername',
    webAppName: 'YourWebAppName',
    adminId: 0
  };
  const initData = tg.initData || '';

  function showStatus(message, type, duration = 3000) {
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type}`;
    setTimeout(() => (statusMessage.style.display = 'none'), duration);
  }

  function toUSDT(cents) { return (Number(cents || 0) / 100).toFixed(2); }

  function setUIFromUser(u) {
    balanceDisplay.textContent = `USDT ${toUSDT(u.balance_cents)}`;
    withdrawBalanceDisplay.textContent = `USDT ${toUSDT(u.balance_cents)}`;
    adCountDisplay.textContent = u.total_ads || 0;
    dailyAdCountDisplay.textContent = `${u.daily_ads || 0} / ${CONFIG.dailyAdLimit}`;

    const canWithdraw = Number(u.balance_cents) >= Number(CONFIG.withdrawThresholdCents);
    mainWithdrawBtn.disabled = !canWithdraw;
    mainWithdrawBtn.textContent = canWithdraw ? 'Go to Withdraw' : `Reach ${toUSDT(CONFIG.withdrawThresholdCents)} USDT to Withdraw`;
    finalWithdrawBtn.disabled = !canWithdraw;
    finalWithdrawBtn.textContent = canWithdraw ? `Withdraw ${toUSDT(u.balance_cents)} USDT` : `Minimum ${toUSDT(CONFIG.withdrawThresholdCents)} USDT required`;

    // Admin panel
    const user = tg.initDataUnsafe?.user;
    if (user && Number(user.id) === Number(CONFIG.adminId)) {
      adminPanel.style.display = 'block';
      userInfoDisplay.textContent = `Welcome, Admin! User: ${user.first_name} (@${user.username || 'N/A'}), ID: ${user.id}`;
    }
  }

  async function api(path, options = {}) {
    const res = await fetch(path, {
      method: options.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        'x-telegram-init-data': initData
      },
      body: options.body ? JSON.stringify(options.body) : undefined
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || `HTTP ${res.status}`);
    }
    return res.json();
  }

  // Load config + user
  try {
    CONFIG = await fetch('/api/config').then(r => r.json());
  } catch (_) {}
  try {
    const me = await api('/api/me');
    setUIFromUser(me.user);
  } catch (e) {
    showStatus('Auth failed. Open from Telegram bot menu.', 'error', 5000);
  }

  // Referral link
  function generateReferralLink() {
    const user = tg.initDataUnsafe?.user;
    if (user && CONFIG.botUsername && CONFIG.webAppName) {
      referralLinkDisplay.textContent = `https://t.me/${CONFIG.botUsername}/${CONFIG.webAppName}?startapp=ref${user.id}`;
    } else {
      referralLinkDisplay.textContent = 'Configure BOT_USERNAME & WEBAPP_NAME on server.';
      referralLinkDisplay.style.color = 'var(--warning-color)';
      referralLinkDisplay.style.cursor = 'default';
    }
  }
  generateReferralLink();

  referralLinkDisplay.addEventListener('click', () => {
    if (navigator.clipboard && referralLinkDisplay.textContent.startsWith('https://')) {
      navigator.clipboard.writeText(referralLinkDisplay.textContent)
        .then(() => showStatus('Referral link copied!', 'success'))
        .catch(() => showStatus('Could not copy link.', 'error'));
    }
  });

  // Handle referral start_param once (claim server-side)
  (async function handleReferralStart() {
    const startParam = tg.initDataUnsafe?.start_param || '';
    if (startParam && startParam.startsWith('ref')) {
      const referrer_id = startParam.replace('ref', '');
      try {
        await api('/api/referral/claim', { method: 'POST', body: { referrer_id } });
        showStatus('Referral detected. Welcome!', 'success', 4000);
        const me = await api('/api/me'); setUIFromUser(me.user);
      } catch (_) {}
    }
  })();

  // Navigation
  function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById(viewId).style.display = 'block';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const map = { 'home-view': 'navHome', 'withdraw-view': 'navWithdraw', 'referral-view': 'navRefer' };
    document.getElementById(map[viewId]).classList.add('active');
  }
  document.getElementById('navHome').addEventListener('click', () => showView('home-view'));
  document.getElementById('navWithdraw').addEventListener('click', () => showView('withdraw-view'));
  document.getElementById('navRefer').addEventListener('click', () => showView('referral-view'));
  mainWithdrawBtn.addEventListener('click', () => showView('withdraw-view'));

  // Ad flow (replace with your network callback)
  async function showRewardedAd() {
    // TODO: Replace this simulation with your ad SDK callback (e.g., Monetag/other)
    // Example for Monetag after load success -> call credit():
    // show_9459352().then(creditAfterAd).catch(() => showStatus('Ad failed', 'error'));
    await new Promise(r => setTimeout(r, 1200)); // simulate ad
    return true;
  }

  async function creditAfterAd() {
    try {
      const r = await api('/api/ad/reward', { method: 'POST' });
      setUIFromUser(r.user);
      showStatus(`+${(CONFIG.adRewardCents/100).toFixed(2)} USDT added`, 'success');
    } catch (e) {
      showStatus(e.message.includes('Daily ad limit') ? 'Daily limit reached' : 'Credit failed', 'error');
    }
  }

  rewardedBtn.addEventListener('click', async () => {
    rewardedBtn.disabled = true;
    showStatus('Loading ad, please wait...', 'info');
    try {
      const ok = await showRewardedAd();
      if (ok) await creditAfterAd();
    } finally {
      rewardedBtn.disabled = false;
      const me = await api('/api/me'); setUIFromUser(me.user);
    }
  });

  // Withdraw
  async function handleWithdrawal() {
    const address = paymentAddressInput.value.trim();
    if (!address) return showStatus('Enter your TRC20 address', 'error');
    try {
      const r = await api('/api/withdraw', { method: 'POST', body: { address } });
      showStatus(r.message || 'Request submitted', 'success', 5000);
      paymentAddressInput.value = '';
      const me = await api('/api/me'); setUIFromUser(me.user);
      showView('home-view');
    } catch (e) {
      showStatus(e.message || 'Withdraw failed', 'error', 5000);
    }
  }
  finalWithdrawBtn.addEventListener('click', handleWithdrawal);
});
</script>
</body>
</html>
<script src='//libtl.com/sdk.js' data-zone='9771272' data-sdk='show_9771272'></script><script src='//libtl.com/sdk.js' data-zone='9771272' data-sdk='show_9771272'></script>